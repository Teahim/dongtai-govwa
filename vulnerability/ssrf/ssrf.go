package ssrf

import (
	"io"
	"net/http"
	"net/url"

	"github.com/julienschmidt/httprouter"

	"github.com/govwa/util"
	"github.com/govwa/util/middleware"
)

type SSRF struct {
	Name string
}

func New() SSRF {
	return SSRF{}
}

func (self SSRF) SetRouter(r *httprouter.Router) {
	mw := middleware.New()
	r.GET("/ssrf", mw.LoggingMiddleware(mw.CapturePanic(mw.AuthCheck(ssrfHandler))))
	r.POST("/ssrf", mw.LoggingMiddleware(mw.CapturePanic(mw.AuthCheck(verifyHandler))))
	r.GET("/ssrfminio", mw.LoggingMiddleware(mw.CapturePanic(mw.AuthCheck(ssrfHandlerMinio))))
	r.POST("/minioLoginSTS", mw.LoggingMiddleware(mw.CapturePanic(mw.AuthCheck(loginSTS))))
}

type JsonRes struct {
	Code int    `json:"code"`
	Msg  string `json:"msg"`
}

func ssrfHandler(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	var data = make(map[string]interface{})
	util.SafeRender(w, r, "template.ssrf", data)
}

func ssrfHandlerMinio(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	var data = make(map[string]interface{})
	util.SafeRender(w, r, "template.ssrfminio", data)
}

func loginSTS(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	v := url.Values{}
	v.Set("Action", "AssumeRoleWithWebIdentity")
	v.Set("WebIdentityToken", "token")
	v.Set("Version", "2011-06-15")
	scheme := "https"
	u := &url.URL{
		Scheme: scheme,
		Host:   r.Host,
	}

	u.RawQuery = v.Encode()

	req, err := http.NewRequest(http.MethodPost, u.String(), nil)
	if err != nil {
		util.RenderAsJson(w, JsonRes{Code: http.StatusInternalServerError, Msg: err.Error()})
		return
	}

	clnt := &http.Client{}

	resp, err := clnt.Do(req)
	body, _ := io.ReadAll(resp.Body)
	defer resp.Body.Close()
	if err != nil {
		util.RenderAsJson(w, JsonRes{Code: http.StatusInternalServerError, Msg: err.Error()})
		return
	}
	if resp.StatusCode != http.StatusOK {
		util.RenderAsJson(w, JsonRes{Code: resp.StatusCode, Msg: err.Error()})
		return
	}
	util.RenderAsJson(w, JsonRes{Code: http.StatusOK, Msg: string(body)})
}

func verifyHandler(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	if r.Method == "POST" {
		//http.NewRequest(,第二个参数,) 返回的第一个参数的ptr
		//http.Do(返回的第一个参数的ptr)
		otp := r.FormValue("url")
		client := http.Client{}
		req, _ := http.NewRequest("GET", otp, nil)
		res, _ := client.Do(req)
		b, _ := io.ReadAll(res.Body)
		resc := JsonRes{
			Code: res.StatusCode,
			Msg:  string(b),
		}
		util.RenderAsJson(w, resc)
	}
}
